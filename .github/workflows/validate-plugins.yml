name: Validate Plugins

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate plugin structure
        run: |
          echo "Validating plugin structure..."

          # Check all plugins have plugin.json
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            if [ ! -f "$plugin_dir.claude-plugin/plugin.json" ]; then
              echo "ERROR: $plugin_name missing .claude-plugin/plugin.json"
              exit 1
            fi
            echo "✓ $plugin_name has plugin.json"
          done

          echo "All plugins validated successfully!"

      - name: Validate JSON files
        run: |
          echo "Validating JSON syntax..."

          # Validate all plugin.json files
          for json_file in plugins/*/.claude-plugin/plugin.json; do
            if ! python3 -m json.tool "$json_file" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in $json_file"
              exit 1
            fi
            echo "✓ $json_file is valid JSON"
          done

          # Validate marketplace.json
          if [ -f ".claude-plugin/marketplace.json" ]; then
            if ! python3 -m json.tool ".claude-plugin/marketplace.json" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in .claude-plugin/marketplace.json"
              exit 1
            fi
            echo "✓ marketplace.json is valid JSON"
          fi

          echo "All JSON files validated!"

      - name: Check for required fields
        run: |
          echo "Checking required fields in plugin.json files..."

          for json_file in plugins/*/.claude-plugin/plugin.json; do
            plugin_name=$(dirname "$json_file" | xargs dirname | xargs basename)

            # Check for name field
            if ! grep -q '"name"' "$json_file"; then
              echo "ERROR: $plugin_name missing 'name' field"
              exit 1
            fi

            # Check for description field
            if ! grep -q '"description"' "$json_file"; then
              echo "ERROR: $plugin_name missing 'description' field"
              exit 1
            fi

            # Check for version field
            if ! grep -q '"version"' "$json_file"; then
              echo "ERROR: $plugin_name missing 'version' field"
              exit 1
            fi

            echo "✓ $plugin_name has all required fields"
          done

          echo "All required fields present!"
